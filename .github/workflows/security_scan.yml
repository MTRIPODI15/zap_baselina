name: Seguridad - ZAP Baseline Scan

# Se ejecuta en cada push a la rama principal (main)
on: 
  push:
    branches: [ "main" ]

jobs:
  security-check:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        name: Descargar el Código

      # --- FASE A: PREPARACIÓN DEL ENTORNO (Target) ---
      
      - name: A.1 Iniciar el Target (OWASP Juice Shop)
        run: |
          echo "Iniciando la aplicación vulnerable de prueba..."
          # Inicia el contenedor de Juice Shop en detached mode (-d)
          docker run -d -p 3000:3000 --name juice-target bkimminich/juice-shop:latest

      - name: A.2 Health Check (Esperar con Bash) - FIX de Estabilidad
        run: |
          echo "Dándole 30 segundos al Target para iniciar servicios internos..."
          sleep 30 # Sleep obligatorio por ser una aplicación Node.js
          
          echo "Verificando si la app en http://localhost:3000/ está lista..."
          # Health Check robusto: reintenta 5 veces, falla si no obtiene 2xx
          curl --fail --retry 5 --retry-delay 5 http://localhost:3000/
          
          echo "Target Juice Shop listo y respondiendo correctamente."

      # --- FASE B: EJECUCIÓN DEL SCANEO (USANDO ACTION OFICIAL) ---
      
      - name: B.1 Ejecutar ZAP Baseline Scan (Action)
        # La action se encarga de descargar la imagen ZAP de forma estable
        uses: zaproxy/action-baseline@v0.12.0 
        with:
          target: 'http://localhost:3000'
          # Los códigos de error de ZAP se manejan por la action.
          # default-max-alerts: Si se excede este valor, el step falla.
          # Un valor de 0 asegura que el pipeline falle si hay CUALQUIER alerta Alta o Media.
          default-max-alerts: 0 
          
      # --- FASE C: REPORTE Y LIMPIEZA ---

      - name: C.1 Limpieza de Contenedor (Bash)
        # La limpieza DEBE ejecutarse siempre, incluso si el step de ZAP (B.1) falla.
        if: always() 
        run: |
          echo "Deteniendo y eliminando el Target para liberar recursos."
          docker stop juice-target
          docker rm juice-target

      - name: C.2 Subir el Reporte ZAP como Artefacto
        # La action de ZAP genera un archivo llamado zap_report.html
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-security-report
          path: zap_report.html