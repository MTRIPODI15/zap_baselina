name: Prueba de Setup de Entorno (Fase A)

# Se ejecuta cada vez que hay un push a la rama principal (main)
on: 
  push:
    branches: [ "main" ]

jobs:
  security-setup-test:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        name: Descargar el Código

      # --- FASE A: PREPARACIÓN DEL ENTORNO (Target) ---
      
      - name: A.1 Iniciar el Target (OWASP Juice Shop)
        run: |
          echo "Iniciando la aplicación vulnerable de prueba..."
          # Inicia el contenedor de Juice Shop en detached mode (-d)
          docker run -d -p 3000:3000 --name juice-target bkimminich/juice-shop:latest

      - name: A.2 Health Check (Esperar con Bash) - FIX
        run: |
          echo "Dándole 30 segundos al Target para iniciar servicios internos..."
          # Añadimos un sleep obligatorio para la inicialización
          sleep 30
          
          echo "Verificando si la app en http://localhost:3000/ está lista..."
          
          # El Health Check robusto de Bash se ejecuta DESPUÉS del sleep.
          # Esto reduce la probabilidad de encontrar el error (56).
          curl --fail --retry 5 --retry-delay 5 http://localhost:3000/
          
          echo "Target Juice Shop listo y respondiendo correctamente."
          
      # --- LIMPIEZA INICIAL (Es temporalmente buena práctica) ---
      
      # Añadimos un paso simple de limpieza para no dejar el contenedor corriendo
      - name: A.3 Limpieza de Contenedor (Bash)
        if: always() # Asegura que se ejecute incluso si el Health Check fallara
        run: |
          echo "Deteniendo y eliminando el Target para liberar recursos."
          docker stop juice-target
          docker rm juice-target

      - name: B.1 Ejecutar ZAP Baseline Scan - FIX
        run: |
          TARGET_URL="http://localhost:3000"
          REPORT_NAME="zap_baseline_report.html"
          
          echo "Iniciando escaneo de ZAP contra $TARGET_URL..."
          
          # CAMBIO CLAVE: Usamos la versión explícita '2.12.0' para evitar problemas de etiquetas genéricas.
          docker run --rm -v $(pwd):/zap/wrk/:rw owasp/zap2docker-stable:2.12.0 zap-baseline.py \
            -t $TARGET_URL \
            -r /zap/wrk/$REPORT_NAME
            
          echo "Intentando descargar ZAP versión 2.12.0..."